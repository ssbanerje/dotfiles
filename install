#!/usr/bin/env bash

set -e

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGDIR="${BASEDIR}/meta/config"
DOTBOT="${BASEDIR}/installer/dotbot/bin/dotbot"
PLUGINDIR="${BASEDIR}/installer/plugins"

# Parse arguments
while (( "$#" )); do
  case "$1" in
    -*|--*)
      FLAGS=$(echo -e "${FLAGS} $1" | sed -e 's/^[[:space:]]*//')
      ;;
    *)
      CONFIGS=$(echo -e "${CONFIGS} $1" | sed -e 's/^[[:space:]]*//')
      ;;
  esac
  shift
done

# Load configuration
for config in base $CONFIGS; do
    echo -e "Adding configuration $config"
    CONFIGCONTENT="${CONFIGCONTENT}\n$(<"${CONFIGDIR}/${config}.yaml")"
done

# Run dotbot
PLUGINS=$(cat <<-END
  --plugin-dir ${PLUGINDIR} --plugin-dir ${PLUGINDIR}/dotbot-ifplatform \
  --plugin-dir ${PLUGINDIR}/dotbot-template --plugin-dir ${PLUGINDIR}/dotbot-pip \
  --plugin-dir ${PLUGINDIR}/dotbot-sudo
END
)
if [[ ! -z "${FLAGS}" ]]; then
  "${DOTBOT}" "${FLAGS}" -d "${BASEDIR}" ${PLUGINS} -c <(echo -e "${CONFIGCONTENT}")
else
  "${DOTBOT}" -d "${BASEDIR}" ${PLUGINS} -c <(echo -e "${CONFIGCONTENT}")
fi
